// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// 客服模型
model Agent {
  id        String   @id @default(cuid())
  agentId   String   @unique @map("agent_id") // 客服工号
  password  String
  name      String
  avatar    String?  @default("/avatars/default.jpg")
  isOnline  Boolean  @default(false) @map("is_online")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关联的会话
  conversations Conversation[] @relation("AgentConversations")
  
  // 关联的快捷模板
  quickTemplates QuickTemplate[]

  @@map("agents")
}

// 客户模型
model Client {
  id        String   @id @default(cuid())
  clientId  String   @unique @map("client_id") // 客户ID
  name      String
  phone     String   @default("") // 客户电话
  isOnline  Boolean  @default(false) @map("is_online")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关联的会话
  conversations Conversation[] @relation("ClientConversations")

  @@map("clients")
}

// 会话模型
model Conversation {
  id           String   @id @default(cuid())
  type         String   @default("agent") // agent, group
  title        String?
  isActive     Boolean  @default(true) @map("is_active")
  lastMessage  String?  @map("last_message") @db.Text
  lastMessageTime DateTime? @map("last_message_time")
  unreadCount  Int      @default(0) @map("unread_count")
  clientDisplayName String?  @map("client_display_name") // 客服对客户的自定义显示名称
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // 关联的客服和客户
  agentId   String? @map("agent_id")
  agent     Agent?  @relation("AgentConversations", fields: [agentId], references: [agentId])
  
  clientId  String? @map("client_id")
  client    Client? @relation("ClientConversations", fields: [clientId], references: [clientId])

  // 关联的消息
  messages Message[]

  @@map("conversations")
}

// 消息模型
model Message {
  id             String   @id @default(cuid())
  conversationId String   @map("conversation_id")
  senderId       String   @map("sender_id")
  content        String   @db.Text  
  type           String   @default("text") // text, emoji, image, file
  status         String   @default("sent") // sending, sent, delivered, read
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // 关联的会话
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("messages")
}

// 快捷模板模型
model QuickTemplate {
  id        String   @id @default(cuid())
  agentId   String   @map("agent_id")
  title     String   @default("") // 模板标题
  content   String   @db.Text // 模板内容
  order     Int      @default(0) // 排序
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // 关联的客服
  agent Agent @relation(fields: [agentId], references: [agentId], onDelete: Cascade)

  @@map("quick_templates")
}

// 客户表单模型
model ClientForm {
  id              String    @id @default(cuid())
  conversationId String    @unique @map("conversation_id")
  clientId       String    @map("client_id")

  // 表单字段
  name            String?   // 姓名
  city            String?   // 城市区镇
  phone           String?   // 手机号码
  ageGender       String?   @map("age_gender") // 性别几岁
  loanAmount      String?   @map("loan_amount") // 要借多少
  jobPosition     String?   @map("job_position") // 工作岗位
  jobDuration     String?   @map("job_duration") // 做了多久
  monthlyIncome   String?   @map("monthly_income") // 月入多少
  payday          String?   // 发工资日
  housingDuration String?   @map("housing_duration") // 住房多久
  rent            String?   // 租金多少
  livingWith      String?   @map("living_with") // 跟谁同住
  maritalStatus   String?   @map("marital_status") // 婚姻状况
  hasChildren     String?   @map("has_children") // 有无子女
  creditStatus    String?   @map("credit_status") // 征信情况
  loanPurpose     String?   @map("loan_purpose") // 借款用途
  hasProperty     String?   @map("has_property") // 有无房车
  emptyLoan       String?   @map("empty_loan") // 借空放没
  sesameCredit    String?   @map("sesame_credit") // 芝麻信用
  phoneModel      String?   @map("phone_model") // 手机型号
  description     String?   @db.Text // 描述情况

  isCompleted Boolean   @default(false) @map("is_completed") // 是否已完成
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("client_forms")
}
